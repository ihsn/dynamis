

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>1.9. Script 9: Higher Order Births &mdash; DYNAMIS-POP  documentation</title>
  

  
  
  
  

  

  
  
    

  

  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="1.10. Script 10: Child Mortality" href="10_ChildMortality.html" />
    <link rel="prev" title="1.8. Script 8: First Births" href="08_FirstBirths.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> DYNAMIS-POP
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="AnalysisInput-Index.html">1. Parameter Generation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="01_Setup_ABC_2000.html">1.1. Script 1: Country/Version-Specific Setup File</a></li>
<li class="toctree-l2"><a class="reference internal" href="02_CreateStartpop.html">1.2. Script 2: Starting Population</a></li>
<li class="toctree-l2"><a class="reference internal" href="03_PrimaryEducation.html">1.3. Script 3: Primary Education</a></li>
<li class="toctree-l2"><a class="reference internal" href="04_Migration.html">1.4. Script 4: Internal Migration</a></li>
<li class="toctree-l2"><a class="reference internal" href="05_Immigration.html">1.5. Script 5: Immigration</a></li>
<li class="toctree-l2"><a class="reference internal" href="06_Emigration.html">1.6. Script 6: Emigration</a></li>
<li class="toctree-l2"><a class="reference internal" href="07_FirstMarriage.html">1.7. Script 7: First Marriage</a></li>
<li class="toctree-l2"><a class="reference internal" href="08_FirstBirths.html">1.8. Script 8: First Births</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">1.9. Script 9: Higher Order Births</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#file-output">1.9.1. File Output</a></li>
<li class="toctree-l3"><a class="reference internal" href="#code">1.9.2. Code</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="10_ChildMortality.html">1.10. Script 10: Child Mortality</a></li>
<li class="toctree-l2"><a class="reference internal" href="11_Ethnicity.html">1.11. Script 11: Ethnicity</a></li>
<li class="toctree-l2"><a class="reference internal" href="12_SchoolPlanning.html">1.12. Script 12: School Planning</a></li>
<li class="toctree-l2"><a class="reference internal" href="13_LowerSecondary.html">1.13. Script 13: Lower Secondary Education</a></li>
<li class="toctree-l2"><a class="reference internal" href="14_DemProj.html">1.14. Script 14: Demographic Macro-Projections</a></li>
<li class="toctree-l2"><a class="reference internal" href="15_Settings.html">1.15. Script 15: Model Settings</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../AnalysisOutput/AnalysisOutput-Index.html">2. Output Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Model/Model-Index.html">3. Technical Implementation</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">DYNAMIS-POP</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="AnalysisInput-Index.html">1. Parameter Generation</a> &raquo;</li>
        
      <li>1.9. Script 9: Higher Order Births</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/Analysis/AnalysisInput/09_HigherBirths.Rmd.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="script-9-higher-order-births">
<span id="script-9-higher-order-births"></span><h1>1.9. Script 9: Higher Order Births<a class="headerlink" href="#script-9-higher-order-births" title="Permalink to this headline">¶</a></h1>
<blockquote>
<div>Higher order births are estimated using hazard regression. Models are estimated separately by birth order. Baseline hazards are by time since last birth. Relative risks are estimated by education and broad age groups.</div></blockquote>
<div class="section" id="file-output">
<span id="file-output"></span><h2>1.9.1. File Output<a class="headerlink" href="#file-output" title="Permalink to this headline">¶</a></h2>
<p>The R code below produces one parameter table as a Modgen .dat text file:</p>
<ul class="simple">
<li>Baseline and relative risks for higher order births by parity, accounting for time since last birth, age group, and education</li>
</ul>
<p><img alt="" src="../../_images/ParaHigherBirths.png" /></p>
</div>
<div class="section" id="code">
<span id="code"></span><h2>1.9.2. Code<a class="headerlink" href="#code" title="Permalink to this headline">¶</a></h2>
<div class="highlight-{r, message=FALSE, warning=FALSE} notranslate"><div class="highlight"><pre><span></span>####################################################################################################
# 
#  DYNAMIS-POP Parameter Generation File 9 - Higher order births
#  This file is generic and works for all country contexts. 
#  Input file: globals_for_analysis.RData (To generate such a file run the setup script)
#  Last Update: Martin Spielauer 2018-05-12
#
####################################################################################################

####################################################################################################
# Clear work space, load required packages and the input object file
####################################################################################################

rm(list=ls())

library(haven)
library(dplyr)
library(data.table)
library(sp) 
library(maptools)
library(survival)
library(fmsb)
library(eha)

load(file=&quot;globals_for_analysis.RData&quot;)
alldat &lt;- g_births_dat

# Set Parameter Output File

parafile &lt;- file(g_para_higherbirths, &quot;w&quot;)

####################################################################################################
# Regression macro
####################################################################################################

BirthRegressionMacro &lt;- function() 
{
  # Read stata file and select mothers 

  seldat &lt;- alldat[!is.na(alldat$r_from),]

  # Event (&quot;Failure&quot;)
  seldat$m_event &lt;- FALSE
  seldat$m_event[!is.na(seldat$r_to)] &lt;- TRUE

  # Time of interview 
  seldat$m_inter &lt;- seldat$M_INTERV/12+1900

  # Start of process (first birth)
  seldat$m_start &lt;- (seldat$r_from)/12+1900

  # Remove births in interview month (no observation time) and births in same month
  seldat &lt;- seldat[seldat$m_start &lt; seldat$m_inter &amp; (is.na(seldat$r_to) | (seldat$r_from!=seldat$r_to)),]

  # Second birth
  seldat$m_birth &lt;- (seldat$r_to)/12+1900

  # End of process: at interview or at second birth
  seldat$m_end &lt;- seldat$m_inter 
  seldat$m_end[!is.na(seldat$m_birth)] &lt;- seldat$m_birth[!is.na(seldat$m_birth)]

  # Process start date (keep it for following splits)
  seldat$m_origin &lt;- seldat$m_start

  # Calendar time split (3 period episodes)
  seldatsplit &lt;- survSplit(seldat, cut=g_birth_timecuts, end=&quot;m_end&quot;, event = &quot;m_event&quot;, start=&quot;m_start&quot;, episode = &quot;m_period&quot; )

  # # Age group split (first recode start and end in terms of mothers age)
  seldatsplit$m_start &lt;- seldatsplit$m_start - ((seldatsplit$M_BIRTH)/12+1900)
  seldatsplit$m_end   &lt;- seldatsplit$m_end   - ((seldatsplit$M_BIRTH)/12+1900)
  seldatsplit         &lt;- survSplit(seldatsplit, cut=c(35,40,45), end=&quot;m_end&quot;, event = &quot;m_event&quot;, start=&quot;m_start&quot;, episode = &quot;m_agegr&quot; )

  # recode start and end with origin 0 at first birth
  seldatsplit$m_start  &lt;- seldatsplit$m_start + ((seldatsplit$M_BIRTH)/12+1900)  - seldatsplit$m_origin
  seldatsplit$m_end    &lt;- seldatsplit$m_end   + ((seldatsplit$M_BIRTH)/12+1900)  - seldatsplit$m_origin

  # new factor in reverse order
  seldatsplit$r_period &lt;- -seldatsplit$m_period + 3

  # piecewise constant 
  birmodel       &lt;- phreg(Surv(time=seldatsplit$m_start, time2=seldatsplit$m_end, event = seldatsplit$m_event) 
                          ~ factor(r_period)+factor(m_agegr)+factor(M_EDUC), 
                          data = seldatsplit, 
                          dist = &quot;pch&quot;, 
                          cuts = c(1, 3, 6, 9, 12)) 

  return(birmodel)
}

####################################################################################################
# Analysis birth 2
####################################################################################################

alldat$r_from    &lt;- alldat$M_B01
alldat$r_to      &lt;- alldat$M_B02
regres_02        &lt;- BirthRegressionMacro()
coef_02          &lt;- exp(regres_02$coefficients)
haz_02           &lt;- regres_02$hazards

####################################################################################################
# Analysis birth 3
####################################################################################################

alldat$r_from    &lt;- alldat$M_B02
alldat$r_to      &lt;- alldat$M_B03
regres_03        &lt;- BirthRegressionMacro()
coef_03          &lt;- exp(regres_03$coefficients)
haz_03           &lt;- regres_03$hazards

####################################################################################################
# Analysis birth 4
####################################################################################################

alldat$r_from    &lt;- alldat$M_B03
alldat$r_to      &lt;- alldat$M_B04
regres_04        &lt;- BirthRegressionMacro()
coef_04          &lt;- exp(regres_04$coefficients)
haz_04           &lt;- regres_04$hazards

####################################################################################################
# Analysis birth 5 - problem
####################################################################################################

alldat$r_from    &lt;- alldat$M_B04
alldat$r_to      &lt;- alldat$M_B05
regres_05        &lt;- BirthRegressionMacro()
coef_05          &lt;- exp(regres_05$coefficients)
haz_05           &lt;- regres_05$hazards

#############################################################################################################
# Analysis birth 6
####################################################################################################

alldat$r_from    &lt;- alldat$M_B05
alldat$r_to      &lt;- alldat$M_B06
regres_06        &lt;- BirthRegressionMacro()
coef_06          &lt;- exp(regres_06$coefficients)
haz_06           &lt;- regres_06$hazards

####################################################################################################
# Analysis birth 7
####################################################################################################

alldat$r_from    &lt;- alldat$M_B06
alldat$r_to      &lt;- alldat$M_B07
regres_07        &lt;- BirthRegressionMacro()
coef_07          &lt;- exp(regres_07$coefficients)
haz_07           &lt;- regres_07$hazards

####################################################################################################
# Analysis birth 8
####################################################################################################

alldat$r_from    &lt;- alldat$M_B07
alldat$r_to      &lt;- alldat$M_B08
regres_08        &lt;- BirthRegressionMacro()
coef_08          &lt;- exp(regres_08$coefficients)
haz_08           &lt;- regres_08$hazards

####################################################################################################
# Analysis birth 9
####################################################################################################

alldat$r_from    &lt;- alldat$M_B08
alldat$r_to      &lt;- alldat$M_B09
regres_09        &lt;- BirthRegressionMacro()
coef_09          &lt;- exp(regres_09$coefficients)
haz_09           &lt;- regres_09$hazards

####################################################################################################
# Analysis birth 10
####################################################################################################

alldat$r_from    &lt;- alldat$M_B09
alldat$r_to      &lt;- alldat$M_B10
regres_10        &lt;- BirthRegressionMacro()
coef_10          &lt;- exp(regres_10$coefficients)
haz_10           &lt;- regres_10$hazards

####################################################################################################
# Produce parameter file
####################################################################################################

m_paras &lt;- rbind(
  c(haz_02,coef_02[c(3,4,5,6,7)]), 
  c(haz_03,coef_03[c(3,4,5,6,7)]),
  c(haz_04,coef_04[c(3,4,5,6,7)]), 
  c(haz_05,coef_05[c(3,4,5,6,7)]),
  c(haz_06,coef_06[c(3,4,5,6,7)]), 
  c(haz_07,coef_07[c(3,4,5,6,7)]),
  c(haz_08,coef_08[c(3,4,5,6,7)]), ## for most country data, estimating higher than 8th birth produces NA
  c(haz_08,coef_08[c(3,4,5,6,7)]), ## for births 8+ the model for 8th births is used
  c(haz_08,coef_08[c(3,4,5,6,7)]), 
  c(haz_08,coef_08[c(3,4,5,6,7)]),
  c(haz_08,coef_08[c(3,4,5,6,7)]), 
  c(haz_08,coef_08[c(3,4,5,6,7)]),
  c(haz_08,coef_08[c(3,4,5,6,7)]), 
  c(haz_08,coef_08[c(3,4,5,6,7)])
)

####################################################################################################
# Write parameter file HigherBirthsParameters.dat
####################################################################################################

# Write the parameter HigherOrderBirthsPara[HIGHER_BIRTHS_PARA][PARITY_RANGE2]

cat(&quot;parameters {\n\n  //EN Higher order births\ndouble HigherOrderBirthsPara[HIGHER_BIRTHS_PARA][PARITY_RANGE2] = {\n&quot;, 
    file=parafile)
cat(format(round(m_paras,5),scientific=FALSE), file=parafile, sep=&quot;, &quot;, append=TRUE)
cat(&quot;\n  }; \n};\n&quot;, file=parafile, append=TRUE) 
close(parafile)
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="10_ChildMortality.html" class="btn btn-neutral float-right" title="1.10. Script 10: Child Mortality" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="08_FirstBirths.html" class="btn btn-neutral" title="1.8. Script 8: First Births" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Martin Spielauer.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>